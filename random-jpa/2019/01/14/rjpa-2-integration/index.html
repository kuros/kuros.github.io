<!DOCTYPE html>

<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="Cache-control" content="public">
		<meta name="msvalidate.01" content="1AAC6AB2F92622321577453EF16C7E43" />

		<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Random-JPA Integration (Contd.) | Kuros.in</title>
<meta name="generator" content="Jekyll v3.8.5" />
<meta property="og:title" content="Random-JPA Integration (Contd.)" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Writing a more complex data setup" />
<meta property="og:description" content="Writing a more complex data setup" />
<link rel="canonical" href="http://0.0.0.0:4000/random-jpa/2019/01/14/rjpa-2-integration/" />
<meta property="og:url" content="http://0.0.0.0:4000/random-jpa/2019/01/14/rjpa-2-integration/" />
<meta property="og:site_name" content="Kuros.in" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-14T00:00:00+00:00" />
<script type="application/ld+json">
{"description":"Writing a more complex data setup","@type":"BlogPosting","url":"http://0.0.0.0:4000/random-jpa/2019/01/14/rjpa-2-integration/","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://0.0.0.0:4000/siteicon.png"}},"headline":"Random-JPA Integration (Contd.)","dateModified":"2019-01-14T00:00:00+00:00","datePublished":"2019-01-14T00:00:00+00:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://0.0.0.0:4000/random-jpa/2019/01/14/rjpa-2-integration/"},"@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

		<link type="application/atom+xml" rel="alternate" href="http://0.0.0.0:4000/feed.xml" title="Kuros.in" />

		<link rel="apple-touch-icon" href="/apple-touch-icon.png">
		<link rel="icon" type="image/png" href="/touch-icon.png" sizes="192x192">
		<link rel="icon" type="image/png" href="/images/favicon.png">

		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300|Rubik:300">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
		<link rel="stylesheet" href="/css/screen.css">
		<!--<link rel="stylesheet" href="/css/style.css">-->

		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=UA-131802948-1"></script>
		<script>
			window.dataLayer = window.dataLayer || [];
			function gtag(){dataLayer.push(arguments);}
			gtag('js', new Date());

			gtag('config', 'UA-131802948-1');
		</script>

		<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
		<script>
			(adsbygoogle = window.adsbygoogle || []).push({
				google_ad_client: "ca-pub-4166026699724584",
				enable_page_level_ads: true
			});
		</script>
	</head>

	<body>
		<header id="mainHeader">
			<div class="container">
				<div class="company-name">
					<a href="/">
						<!--<span class="dark-logo"><img width="104" height="38" src="/images/logo/dark.svg" alt="dark frisco logo"></span>-->
						<!--<span class="light-logo"><img width="104" height="38" src="/images/logo/light.svg" alt="light frisco logo"></span>-->
						<span class="dark-logo">Kuros.in</span>
						<span class="light-logo">Kuros.in</span>
					</a>
				</div>
				<nav>
	<a class="nav-toggle" id="open-nav" href="#">&#9776;</a>
	
		
		

		
		<a href="/random-jpa/" class="" >Random-JPA</a>
	
		
		

		
		<a href="/blog/" class="" >Blog</a>
	
		
		

		
		<a href="/about/" class="" >About</a>
	
		
		

		
		<a href="/contact/" class="" >Contact</a>
	
</nav>

				<!--<p class="editor-link"><a style="display:inline;" href="/_data/navigation.yml" class="btn"><strong>&#9998;</strong> Edit navigation</a></p>-->
			</div>
		</header>

		<section class="hero page-hero random-images" >
	<div class="inner-hero text-container">
		<div class="hero-text-container">
			<h1>Random-JPA Integration (Contd.)</h1>
			<p class="subtext">Writing a more complex data setup</p>
		</div>
	</div>
</section>

<section>
	<div class="blog-post text-container">
		<p class="editor-link"><a href="collections/random-jpa/_posts/2019-01-14-rjpa-2-integration.md" class="btn"><strong>&#9998;</strong> Edit Post</a></p>
		<p class="post-details">
	
		<span class="blog-filter">
			<a href="/category/random-jpa/">Random-jpa</a>
		</span>
	

	
	<span class="post-date">
		January 14, 2019
	</span>
</p>


		<div class="post-content">
			<p>In my previous post, we have written a jpa query to fetch latest salary of employees but there was an error in response, so we are first writing a failing tests to capture the error and then we will fix the bug.</p>

<p>Before we proceed with the new test, lets create a <a href="https://docs.oracle.com/javaee/6/tutorial/doc/gjiup.html">StaticMetaModel</a>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">in</span><span class="o">.</span><span class="na">kuros</span><span class="o">.</span><span class="na">randomjpa</span><span class="o">.</span><span class="na">blogexample</span><span class="o">.</span><span class="na">entity</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.metamodel.SingularAttribute</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">javax.persistence.metamodel.StaticMetamodel</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.time.LocalDate</span><span class="o">;</span>

<span class="nd">@StaticMetamodel</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Salary_</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">employeeId</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="n">salary</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">LocalDate</span><span class="o">&gt;</span> <span class="n">fromDate</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">volatile</span> <span class="n">SingularAttribute</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">LocalDate</span><span class="o">&gt;</span> <span class="n">toDate</span><span class="o">;</span>

<span class="o">}</span>
</code></pre></div></div>

<p>It’s time to test our query with more intensive data. In this scenario, we want to create two salary records for a given employee with custom from and to dates, and fetch his latest salary.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nd">@Test</span> <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldTestToFetchLatestSalaryRecordForMultipleEntry</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">JPAContext</span> <span class="n">jpaContext</span> <span class="o">=</span> <span class="n">JPAContextFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Database</span><span class="o">.</span><span class="na">MY_SQL</span><span class="o">,</span> <span class="n">entityManager</span><span class="o">)</span>
                <span class="o">.</span><span class="na">generate</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">oldFromDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusDays</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">oldToDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">newFromDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">newToDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>


        <span class="kd">final</span> <span class="n">ResultMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">jpaContext</span><span class="o">.</span><span class="na">createAndPersist</span><span class="o">(</span>
                <span class="n">Entity</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">oldFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">oldToDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">newFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">newToDate</span><span class="o">));</span>

        <span class="n">resultMap</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span> <span class="c1">//just for debugging</span>

        <span class="kd">final</span> <span class="n">Salary</span> <span class="n">salary1</span> <span class="o">=</span> <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Salary</span> <span class="n">salary2</span> <span class="o">=</span> <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">latestSalaries</span> <span class="o">=</span> <span class="n">salaryRepository</span><span class="o">.</span><span class="na">findLatestSalaries</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">latestSalaries</span>
                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">sal</span> <span class="o">-&gt;</span> <span class="n">sal</span><span class="o">.</span><span class="na">getEmployeeId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">salary1</span><span class="o">.</span><span class="na">getEmployeeId</span><span class="o">())).</span><span class="na">findFirst</span><span class="o">();</span>

        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>

        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">"The salary id should match with latest salary"</span><span class="o">,</span> <span class="n">salary2</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getSalary</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSalary</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getFromDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getFromDate</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getToDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getToDate</span><span class="o">());</span>
    <span class="o">}</span>
</code></pre></div></div>
<p>And when you run the test it fails</p>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└── *ROOT*
    └── in.kuros.randomjpa.blogexample.entity.Employee|0 [empNo: 10019]
        ├── in.kuros.randomjpa.blogexample.entity.Salary|0 [id: 19]
        └── in.kuros.randomjpa.blogexample.entity.Salary|1 [id: 20]



java.lang.AssertionError: The salary id should match with latest salary 
Expected :20
Actual   :19
 &lt;Click to see difference&gt;


	at org.junit.Assert.fail(Assert.java:88)
	at org.junit.Assert.failNotEquals(Assert.java:834)
	at org.junit.Assert.assertEquals(Assert.java:118)
	at in.kuros.randomjpa.blogexample.repository.SalaryRepositoryTest.shouldTestToFetchLatestSalaryRecordForMultipleEntry(SalaryRepositoryTest.java:84)
	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.lang.reflect.Method.invoke(Method.java:498)
	at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)
	at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)
	at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)
	at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)
	at org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:74)
	at org.springframework.test.context.junit4.statements.RunAfterTestExecutionCallbacks.evaluate(RunAfterTestExecutionCallbacks.java:84)
	at org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75)
	at org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86)
	at org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84)
	at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:251)
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97)
	at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)
	at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)
	at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)
	at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)
	at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)
	at org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61)
	at org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70)
	at org.junit.runners.ParentRunner.run(ParentRunner.java:363)
	at org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190)
	at org.junit.runner.JUnitCore.run(JUnitCore.java:137)
	at com.intellij.junit4.JUnit4IdeaTestRunner.startRunnerWithArgs(JUnit4IdeaTestRunner.java:68)
	at com.intellij.rt.execution.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:47)
	at com.intellij.rt.execution.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:242)
	at com.intellij.rt.execution.junit.JUnitStarter.main(JUnitStarter.java:70)
</code></pre></div></div>

<p>So now we have a failing test, but before we move to fixing our query let’s understand the syntax.</p>

<h2 id="test-breakdown">Test Breakdown</h2>
<p>Our aim was to create two salaries for 1 employee with different date ranges:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">final</span> <span class="n">ResultMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">jpaContext</span><span class="o">.</span><span class="na">createAndPersist</span><span class="o">(</span>
                <span class="n">Entity</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">oldFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">oldToDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">newFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">newToDate</span><span class="o">));</span>
</code></pre></div></div>

<p>Here we told random-JPA to create 2 copies of Salary, in the background it determined its parent structure and created two rows Salary object. 
Also you are providing custom values of each attributes you want to override, for entity referenced by index of creation order.</p>

<p>So here we are saying we want to set oldFromDate/oldToDate to Salary row 1 &amp; newFromDate/newToDate to salary row 2.</p>

<p>Simple isn’t it.</p>

<p>checkout the <a href="https://github.com/kuros/random-jpa-example/commit/ba143f36756125c6b7a00b9600b739b4ba7727ac">Commit History</a> on github</p>

<h2 id="time-to-fix-the-test">Time to fix the test</h2>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RepositoryRestResource</span><span class="o">(</span><span class="n">collectionResourceRel</span> <span class="o">=</span> <span class="s">"salary"</span><span class="o">,</span> <span class="n">path</span> <span class="o">=</span> <span class="s">"salary"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">SalaryRepository</span> <span class="kd">extends</span> <span class="n">PagingAndSortingRepository</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">,</span> <span class="n">Integer</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@RestResource</span><span class="o">(</span><span class="n">path</span> <span class="o">=</span> <span class="s">"latest"</span><span class="o">)</span>
    <span class="nd">@Query</span><span class="o">(</span><span class="s">"FROM Salary s WHERE NOT EXISTS (select 1 FROM Salary s2 WHERE s.employeeId = s2.employeeId and s.fromDate &lt; s2.fromDate and s.toDate &lt; s2.toDate) "</span><span class="o">)</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="nf">findLatestSalaries</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>You run the test and it passes. <strong>Hurray !!!</strong></p>

<p>checkout the <a href="https://github.com/kuros/random-jpa-example/commit/c4185eabad25089f5f51383837de4e61cdbd0896">Commit History</a> on github</p>

<h2 id="make-jpacontext-singleton">Make JPAContext Singleton</h2>

<p>Before we end the tutorial, one important thing remaining.</p>

<p>We should make JPAContext as a singleton object since loading the context is an heavy operation as build an internal hierarchy graph and entity mappings.</p>

<p>In this tutorial we will create JPAContext bean.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.Database</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.JPAContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.JPAContextFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Bean</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.persistence.EntityManager</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfig</span> <span class="o">{</span>

    <span class="nd">@Autowired</span> <span class="kd">private</span> <span class="n">EntityManager</span> <span class="n">entityManager</span><span class="o">;</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="n">JPAContext</span> <span class="nf">createJpaContext</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">JPAContextFactory</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="n">Database</span><span class="o">.</span><span class="na">MY_SQL</span><span class="o">,</span> <span class="n">entityManager</span><span class="o">).</span><span class="na">generate</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>And modified our test to use autowired JPAContext. Now you made sure you are loading JPAContext only once.</p>

<h2 id="complete-test">Complete Test</h2>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">in</span><span class="o">.</span><span class="na">kuros</span><span class="o">.</span><span class="na">randomjpa</span><span class="o">.</span><span class="na">blogexample</span><span class="o">.</span><span class="na">repository</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.JPAContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.persistor.model.ResultMap</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.github.kuros.random.jpa.types.Entity</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">in.kuros.randomjpa.blogexample.entity.Salary</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">in.kuros.randomjpa.blogexample.entity.Salary_</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Assert</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.boot.test.context.SpringBootTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.test.context.junit4.SpringRunner</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.time.LocalDate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="nd">@RunWith</span><span class="o">(</span><span class="n">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SalaryRepositoryTest</span> <span class="o">{</span>

    <span class="nd">@Autowired</span> <span class="kd">private</span> <span class="n">JPAContext</span> <span class="n">jpaContext</span><span class="o">;</span>
    <span class="nd">@Autowired</span> <span class="kd">private</span> <span class="n">SalaryRepository</span> <span class="n">salaryRepository</span><span class="o">;</span>

    <span class="nd">@Test</span> <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldTestForFetchingSalaryRecordForOnlyOneEntry</span><span class="o">()</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="n">ResultMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">jpaContext</span><span class="o">.</span><span class="na">createAndPersist</span><span class="o">(</span><span class="n">Entity</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">));</span>
        <span class="n">resultMap</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">Salary</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">latestSalaries</span> <span class="o">=</span> <span class="n">salaryRepository</span><span class="o">.</span><span class="na">findLatestSalaries</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">latestSalaries</span>
                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">sal</span> <span class="o">-&gt;</span> <span class="n">sal</span><span class="o">.</span><span class="na">getId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">salary</span><span class="o">.</span><span class="na">getId</span><span class="o">())).</span><span class="na">findFirst</span><span class="o">();</span>

        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary</span><span class="o">.</span><span class="na">getSalary</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSalary</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary</span><span class="o">.</span><span class="na">getFromDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getFromDate</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary</span><span class="o">.</span><span class="na">getToDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getToDate</span><span class="o">());</span>
    <span class="o">}</span>

    <span class="nd">@Test</span> <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldTestToFetchLatestSalaryRecordForMultipleEntry</span><span class="o">()</span> <span class="o">{</span>

        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">oldFromDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusDays</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">oldToDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">minusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">newFromDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">();</span>
        <span class="kd">final</span> <span class="n">LocalDate</span> <span class="n">newToDate</span> <span class="o">=</span> <span class="n">LocalDate</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusDays</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>


        <span class="kd">final</span> <span class="n">ResultMap</span> <span class="n">resultMap</span> <span class="o">=</span> <span class="n">jpaContext</span><span class="o">.</span><span class="na">createAndPersist</span><span class="o">(</span>
                <span class="n">Entity</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">2</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">oldFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">oldToDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">fromDate</span><span class="o">,</span> <span class="n">newFromDate</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">with</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">Salary_</span><span class="o">.</span><span class="na">toDate</span><span class="o">,</span> <span class="n">newToDate</span><span class="o">));</span>

        <span class="n">resultMap</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">::</span><span class="n">println</span><span class="o">);</span> <span class="c1">//just for debugging</span>

        <span class="kd">final</span> <span class="n">Salary</span> <span class="n">salary1</span> <span class="o">=</span> <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
        <span class="kd">final</span> <span class="n">Salary</span> <span class="n">salary2</span> <span class="o">=</span> <span class="n">resultMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">Salary</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="mi">1</span><span class="o">);</span>

        <span class="kd">final</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">latestSalaries</span> <span class="o">=</span> <span class="n">salaryRepository</span><span class="o">.</span><span class="na">findLatestSalaries</span><span class="o">();</span>

        <span class="kd">final</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Salary</span><span class="o">&gt;</span> <span class="n">result</span> <span class="o">=</span> <span class="n">latestSalaries</span>
                <span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">sal</span> <span class="o">-&gt;</span> <span class="n">sal</span><span class="o">.</span><span class="na">getEmployeeId</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">salary1</span><span class="o">.</span><span class="na">getEmployeeId</span><span class="o">())).</span><span class="na">findFirst</span><span class="o">();</span>

        <span class="n">Assert</span><span class="o">.</span><span class="na">assertTrue</span><span class="o">(</span><span class="n">result</span><span class="o">.</span><span class="na">isPresent</span><span class="o">());</span>

        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="s">"The salary id should match with latest salary"</span><span class="o">,</span> <span class="n">salary2</span><span class="o">.</span><span class="na">getId</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getSalary</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getSalary</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getFromDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getFromDate</span><span class="o">());</span>
        <span class="n">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">(</span><span class="n">salary2</span><span class="o">.</span><span class="na">getToDate</span><span class="o">(),</span> <span class="n">result</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getToDate</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>checkout the <a href="https://github.com/kuros/random-jpa-example/commit/83efda2d2b9410a662df22c06d8cceb0112804a7">Commit History</a> on github</p>



			<div class="blog-navigation">
				
					
					<a class="prev" href="/random-jpa/2019/01/14/rjpa-1-integration/">&laquo; Random-JPA Integration</a>
					

					
				
			</div>

			<div class="author">
				
				
				<div class="square-image" style="background-image: url('/images/about/myphoto.webp')"></div>
				<p class="blurb">I like long drives, bike trip & good food.</p>
			</div>








			<div id="disqus_thread"></div>
			<script>

				/**
				 *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
				 *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

                var disqus_config = function () {
                this.page.url = "http://0.0.0.0:4000/random-jpa/2019/01/14/rjpa-2-integration/";  // Replace PAGE_URL with your page's canonical URL variable
                this.page.identifier = "/random-jpa/2019/01/14/rjpa-2-integration"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                };

				(function() { // DON'T EDIT BELOW THIS LINE
					var d = document, s = d.createElement('script');
					s.src = 'https://kuros-in.disqus.com/embed.js';
					s.setAttribute('data-timestamp', +new Date());
					(d.head || d.body).appendChild(s);
				})();
			</script>
			<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

		</div>
	</div>
</section>



		<footer>
			<div class="container">
				<!--<p class="editor-link"><a href="/_data/footer.yml" class="btn"><strong>&#9998;</strong> Edit footer</a></p>-->
				<ul class="footer-left-links">
					
						<li>
							<a  href="/random-jpa/" >
								
								Random-JPA
							</a>
						</li>
					
						<li>
							<a  href="/blog/" >
								
								Blog
							</a>
						</li>
					
						<li>
							<a  href="/about/" >
								
								About
							</a>
						</li>
					
						<li>
							<a  href="/contact/" >
								
								Contact
							</a>
						</li>
					
				</ul>
				<ul class="footer-right-links">
					
						<li>
							<a target="_blank" href="https://www.facebook.com/kumarrohit.1010" class="facebook-icon">
								
		<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M19,4V7H17A1,1 0 0,0 16,8V10H19V13H16V20H13V13H11V10H13V7.5C13,5.56 14.57,4 16.5,4M20,2H4A2,2 0 0,0 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4C22,2.89 21.1,2 20,2Z" /></svg>
	
								
							</a>
						</li>
					
						<li>
							<a target="_blank" href="https://twitter.com/incrv83" class="twitter-icon">
								
		<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z" /></svg>
	
								
							</a>
						</li>
					
						<li>
							<a target="_blank" href="https://www.linkedin.com/in/kumar-rohit-9a985517/" class="linkedin-icon">
								
		<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M19,19H16V13.7A1.5,1.5 0 0,0 14.5,12.2A1.5,1.5 0 0,0 13,13.7V19H10V10H13V11.2C13.5,10.36 14.59,9.8 15.5,9.8A3.5,3.5 0 0,1 19,13.3M6.5,8.31C5.5,8.31 4.69,7.5 4.69,6.5A1.81,1.81 0 0,1 6.5,4.69C7.5,4.69 8.31,5.5 8.31,6.5A1.81,1.81 0 0,1 6.5,8.31M8,19H5V10H8M20,2H4C2.89,2 2,2.89 2,4V20A2,2 0 0,0 4,22H20A2,2 0 0,0 22,20V4C22,2.89 21.1,2 20,2Z" /></svg>
	
								
							</a>
						</li>
					
						<li>
							<a  href="/feed.xml" class="rss-icon">
								
		<svg fill="#000000" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h24v24H0z" fill="none"/><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
	
								
							</a>
						</li>
					
				</ul>
				<p class="copyright">
					<a href="https://cloudcannon.com/">
						Template by CloudCannon
					</a>
				</p>
			</div>
		</footer>

		<script src="//ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="/js/main.js"></script>

		<a id="back2Top" title="Back to top" href="#">&#10148;</a>
	</body>
</html>
